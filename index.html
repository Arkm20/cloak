<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Cloak</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
            overflow: hidden; /* Prevent main scrollbars */
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .browser-window {
            width: 95vw;
            height: 95vh;
            max-width: 1200px; /* Max width for larger screens */
            max-height: 800px; /* Max height */
            border: 1px solid #ccc;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            background-color: #fff;
            overflow: hidden; /* Hide potential scrollbars from inner elements */
            border-radius: 8px;
        }

        .toolbar {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background-color: #e9e9e9;
            border-bottom: 1px solid #ccc;
            gap: 5px;
        }

        .toolbar button {
            padding: 4px 8px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: #f0f0f0;
            font-size: 12px;
        }
         .toolbar button:hover {
             background-color: #e0e0e0;
         }
         .toolbar button:active {
             background-color: #d0d0d0;
         }

        .address-bar {
            flex-grow: 1;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 14px;
            outline: none;
        }

        .tabs-container {
            display: flex;
            background-color: #d9d9d9;
            border-bottom: 1px solid #bbb;
            padding-left: 10px;
            overflow-x: auto; /* Enable horizontal scrolling for many tabs */
            overflow-y: hidden;
            white-space: nowrap; /* Prevent tabs from wrapping */
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            -ms-overflow-style: none;  /* Hide scrollbar for IE and Edge */
        }
         .tabs-container::-webkit-scrollbar { /* Hide scrollbar for Chrome, Safari, Opera */
             display: none;
         }


        .tab {
            display: inline-flex; /* Use inline-flex to align items and keep them inline */
            align-items: center;
            background-color: #e9e9e9;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
            padding: 6px 10px 4px 10px; /* Adjust padding for better look */
            margin-right: 5px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-bottom: none;
            max-width: 180px; /* Limit tab width */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative; /* Needed for z-index */
            top: 1px; /* Creates overlap effect */
            font-size: 13px;
        }

        .tab.active {
            background-color: #fff;
            border-bottom-color: #fff;
            z-index: 1; /* Bring active tab to front */
        }
        .tab:hover:not(.active) {
            background-color: #f5f5f5;
        }

        .tab-title {
            flex-grow: 1;
            margin-right: 8px; /* Space between title and close button */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .close-tab {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            margin: 0;
            color: #555;
            line-height: 1; /* Prevent extra space below */
            opacity: 0.7;
        }
        .close-tab:hover {
            color: #000;
            opacity: 1;
        }

        .add-tab-button {
             padding: 6px 10px;
             background-color: #e9e9e9;
             border: 1px solid #ccc;
             border-bottom: none;
             border-top-left-radius: 5px;
             border-top-right-radius: 5px;
             cursor: pointer;
             font-size: 14px;
             margin-left: 5px;
             align-self: flex-end; /* Align to the bottom of the tabs container */
             margin-bottom: 1px; /* Match the 'top: 1px' of tabs */
        }
        .add-tab-button:hover {
             background-color: #f5f5f5;
        }


        .content-area {
            flex-grow: 1;
            overflow: hidden; /* Hide iframe scrollbars sometimes */
            display: flex; /* Use flex to make iframe fill */
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Optional: Style for favicon placeholder */
        .favicon-placeholder {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üìÑ</text></svg>'); /* Simple document emoji placeholder */
            background-size: cover;
            flex-shrink: 0; /* Prevent shrinking */
        }

    </style>
</head>
<body>

    <div class="browser-window">
        <div class="toolbar">
            <button id="backBtn" title="Back">‚Üê</button>
            <button id="forwardBtn" title="Forward">‚Üí</button>
            <button id="refreshBtn" title="Refresh">‚ü≥</button>
            <input type="text" class="address-bar" id="addressBar" value="about:blank" placeholder="Enter URL">
            <button id="goBtn" title="Go">Go</button>
        </div>
        <div class="tabs-container" id="tabsContainer">
            <!-- Tabs will be added here by JavaScript -->
            <button class="add-tab-button" id="addTabBtn" title="New Tab">+</button>
        </div>
        <div class="content-area">
            <iframe id="contentFrame" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        const addressBar = document.getElementById('addressBar');
        const goBtn = document.getElementById('goBtn');
        const contentFrame = document.getElementById('contentFrame');
        const tabsContainer = document.getElementById('tabsContainer');
        const addTabBtn = document.getElementById('addTabBtn');
        const backBtn = document.getElementById('backBtn');
        const forwardBtn = document.getElementById('forwardBtn');
        const refreshBtn = document.getElementById('refreshBtn');

        let tabs = []; // Array to hold tab objects: { id: timestamp, url: string, title: string, active: boolean }
        let activeTabId = null;
        const localStorageKey = 'browserCloakTabs'; // Key for localStorage

        // --- Persistence (Saving/Loading State - acts like saving "cookies" for tabs) ---
        function saveState() {
            localStorage.setItem(localStorageKey, JSON.stringify({ tabs, activeTabId }));
        }

        function loadState() {
            const savedState = localStorage.getItem(localStorageKey);
            if (savedState) {
                const state = JSON.parse(savedState);
                tabs = state.tabs;
                activeTabId = state.activeTabId;

                // Validate active tab - if activeTabId doesn't exist anymore, pick one
                if (!tabs.find(tab => tab.id === activeTabId) && tabs.length > 0) {
                    activeTabId = tabs[0].id;
                    tabs[0].active = true;
                    // Ensure only one tab is active
                    tabs.forEach(tab => {
                        if (tab.id !== activeTabId) tab.active = false;
                    });
                }

            }

            // If no state loaded or tabs are empty, add a default blank tab
            if (tabs.length === 0) {
                addTab('about:blank', 'New Tab', true);
            } else {
                 // Ensure only one tab is active after loading
                let activeCount = 0;
                tabs.forEach(tab => {
                    if (tab.active) activeCount++;
                });
                if (activeCount === 0 && tabs.length > 0) {
                     tabs[0].active = true;
                     activeTabId = tabs[0].id;
                } else if (activeCount > 1) {
                    // Deactivate all but the first active one found
                    let firstActive = true;
                     tabs.forEach(tab => {
                        if(tab.active) {
                            if (firstActive) {
                                activeTabId = tab.id;
                                firstActive = false;
                            } else {
                                tab.active = false;
                            }
                        }
                    });
                }
                renderTabs(); // Render loaded tabs
                activateTab(activeTabId, false); // Activate the correct tab without saving state immediately
            }
        }

        // --- Tab Management ---

        function renderTabs() {
            // Clear current tabs (except the add button)
            tabsContainer.querySelectorAll('.tab').forEach(tabEl => tabEl.remove());

            tabs.forEach(tab => {
                const tabEl = document.createElement('div');
                tabEl.classList.add('tab');
                if (tab.id === activeTabId) {
                    tabEl.classList.add('active');
                }
                tabEl.dataset.tabId = tab.id;

                // Optional: Favicon placeholder
                const favicon = document.createElement('span');
                favicon.classList.add('favicon-placeholder');
                tabEl.appendChild(favicon);


                const titleSpan = document.createElement('span');
                titleSpan.classList.add('tab-title');
                titleSpan.textContent = tab.title || 'Loading...'; // Display current title or placeholder
                tabEl.appendChild(titleSpan);

                const closeBtn = document.createElement('button');
                closeBtn.classList.add('close-tab');
                closeBtn.textContent = '√ó';
                closeBtn.title = 'Close Tab';
                closeBtn.onclick = (e) => {
                    e.stopPropagation(); // Prevent activating the tab when closing
                    closeTab(tab.id);
                };
                tabEl.appendChild(closeBtn);

                // Insert tab before the "+" button
                tabsContainer.insertBefore(tabEl, addTabBtn);

                // Add click listener to activate tab
                tabEl.onclick = () => activateTab(tab.id);
            });

            // Scroll to show the active tab if it's off-screen
            const activeTabEl = tabsContainer.querySelector('.tab.active');
            if (activeTabEl) {
                 activeTabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function addTab(url, title = 'New Tab', makeActive = true) {
            const newTabId = Date.now() + Math.random(); // Simple unique ID

            // Deactivate current active tab if adding a new active one
            if (makeActive && activeTabId !== null) {
                 tabs.forEach(tab => tab.active = false);
            }

            const newTab = {
                id: newTabId,
                url: url,
                title: title,
                active: makeActive
            };

            tabs.push(newTab);
            activeTabId = makeActive ? newTabId : activeTabId;

            renderTabs();
            saveState(); // Save state after adding
            if (makeActive) {
                 loadUrlInFrame(url); // Load URL if new tab is active
                 addressBar.value = url;
            }
        }

        function activateTab(tabId, save=true) {
            const tabToActivate = tabs.find(tab => tab.id === tabId);

            if (tabToActivate && tabId !== activeTabId) {
                // Deactivate the current active tab
                tabs.forEach(tab => tab.active = false);

                // Activate the selected tab
                tabToActivate.active = true;
                activeTabId = tabId;

                // Update UI
                renderTabs();
                addressBar.value = tabToActivate.url;
                loadUrlInFrame(tabToActivate.url); // Load URL in the single iframe

                if(save) saveState(); // Save state after activating
            } else if (tabToActivate && tabId === activeTabId) {
                 // Tab is already active, just ensure UI matches state
                 addressBar.value = tabToActivate.url;
                 // No need to re-render or re-load iframe if already active
            }
        }


        function closeTab(tabId) {
            const indexToRemove = tabs.findIndex(tab => tab.id === tabId);

            if (indexToRemove !== -1) {
                const wasActive = tabs[indexToRemove].active;
                tabs.splice(indexToRemove, 1); // Remove the tab

                // If the closed tab was active
                if (wasActive) {
                    // Activate the tab to the left, or the first one if it was the first/only tab
                    if (tabs.length > 0) {
                        const newActiveIndex = Math.max(0, indexToRemove - 1);
                        activateTab(tabs[newActiveIndex].id);
                    } else {
                        // If no tabs left, add a new blank one
                        activeTabId = null; // No active tab temporarily
                        addTab('about:blank', 'New Tab', true); // This will set activeTabId and save state
                        return; // Exit function as new tab handling takes over
                    }
                }

                renderTabs();
                saveState(); // Save state after closing
            }
        }

        // --- Iframe / Navigation ---

        function loadUrlInFrame(url) {
            // Basic URL normalization: Add http if no protocol
            if (url && url !== 'about:blank' && !url.match(/^[a-zA-Z]+:\/\//)) {
                 url = 'http://' + url;
                 // Update the stored URL for the active tab
                 const activeTab = tabs.find(tab => tab.id === activeTabId);
                 if (activeTab) {
                     activeTab.url = url;
                     saveState(); // Save the corrected URL
                 }
                 addressBar.value = url; // Update address bar immediately
            }
             try {
                contentFrame.src = url;
             } catch (e) {
                 console.error("Failed to load URL:", url, e);
                 // Optionally display an error in the iframe or address bar
             }
        }

        // --- Event Handlers ---

        goBtn.addEventListener('click', () => {
            const url = addressBar.value;
             if (activeTabId) {
                 // Update the URL for the current active tab
                 const activeTab = tabs.find(tab => tab.id === activeTabId);
                 if (activeTab) {
                     activeTab.url = url;
                      // Set initial title to URL, will try to update later
                     activeTab.title = url.replace(/^https?:\/\/(www\.)?/, '').split('/')[0] || 'Loading...';
                 }
                 loadUrlInFrame(url);
                 renderTabs(); // Update tab title display
                 saveState();
             } else {
                 // Should not happen if loadState adds a tab when empty, but as a fallback
                 addTab(url, url.replace(/^https?:\/\/(www\.)?/, '').split('/')[0] || url, true);
             }
        });

        addressBar.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default form submission if any
                goBtn.click(); // Simulate clicking the Go button
            }
        });

        addTabBtn.addEventListener('click', () => {
            addTab('about:blank', 'New Tab', true);
        });

        // Attempt to update tab title and URL from iframe (Subject to Same-Origin Policy)
        contentFrame.addEventListener('load', () => {
            if (activeTabId) {
                const activeTab = tabs.find(tab => tab.id === activeTabId);
                if (activeTab) {
                    try {
                        // Try to get the actual URL (handles redirects within same origin, often fails cross-origin)
                        const actualUrl = contentFrame.contentWindow.location.href;
                         activeTab.url = actualUrl;
                         addressBar.value = actualUrl; // Update address bar with final URL

                        // Try to get the page title (fails cross-origin)
                        const pageTitle = contentFrame.contentWindow.document.title;
                        activeTab.title = pageTitle || actualUrl.replace(/^https?:\/\/(www\.)?/, '').split('/')[0] || 'Untitled Tab';

                    } catch (e) {
                        // Same-Origin Policy blocked access
                        console.warn("Same-Origin Policy blocked access to iframe location/title:", e);
                        // Fallback: Use the URL we tried to load, keep existing title or show basic host
                         const fallbackTitle = activeTab.url.replace(/^https?:\/\/(www\.)?/, '').split('/')[0] || 'Untitled Tab';
                         if (!activeTab.title || activeTab.title === 'Loading...') { // Only update if title wasn't set or was placeholder
                              activeTab.title = fallbackTitle;
                         }
                         addressBar.value = activeTab.url; // Ensure address bar shows what we have recorded
                    } finally {
                        renderTabs(); // Always re-render to show potentially updated title
                        saveState(); // Always save state after load (title/url might have changed)
                    }
                }
            }
             // Enable back/forward/refresh if history state is available (still subject to same-origin for actual action)
             // This is more of a visual indicator, actual history might be blocked
             try {
                 backBtn.disabled = !contentFrame.contentWindow.history || contentFrame.contentWindow.history.length <= 1;
                 forwardBtn.disabled = !contentFrame.contentWindow.history || contentFrame.contentWindow.history.length <= contentFrame.contentWindow.history.state; // This logic is simplified, might not be accurate cross-origin
             } catch (e) {
                  // Same-Origin Policy again
                 backBtn.disabled = true;
                 forwardBtn.disabled = true;
             }
              refreshBtn.disabled = false; // Refresh button is always potentially usable
        });

        // Navigation buttons (Subject to Same-Origin Policy)
        backBtn.addEventListener('click', () => {
             try { contentFrame.contentWindow.history.back(); } catch(e) { console.warn("Back blocked by SOP:", e); }
        });
        forwardBtn.addEventListener('click', () => {
             try { contentFrame.contentWindow.history.forward(); } catch(e) { console.warn("Forward blocked by SOP:", e); }
        });
        refreshBtn.addEventListener('click', () => {
            // Refresh reloads the current src, or reloads the iframe if src is the same
            // For same-origin, history.go(0) is better, but src reload works cross-origin too.
             try { contentFrame.contentWindow.location.reload(); } catch(e) { console.warn("Refresh blocked by SOP:", e); }
             // Simpler fallback: contentFrame.src = contentFrame.src;
        });


        // --- Initialization ---
        loadState(); // Load tabs and state from localStorage on page load

    </script>

</body>
</html>
